!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(global,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=12)}([function(e,t){e.exports=require("typedarray-to-buffer")},function(e,t){e.exports=require("libsodium-wrappers")},function(e,t){e.exports=require("bignumber.js")},function(e,t){e.exports=require("elliptic")},function(e,t){e.exports=require("bs58check")},function(e,t){e.exports=require("pbkdf2")},function(e,t){e.exports=require("buffer/")},function(e,t){e.exports=require("@taquito/michelson-encoder")},function(e,t){e.exports=require("blake2b")},function(e,t){e.exports=require("@ledgerhq/hw-transport-node-hid")},function(e,t){e.exports=require("bip39")},function(e,t){e.exports=require("xhr2")},function(e,t,r){"use strict";r.r(t);var n=r(11),i=r.n(n);var s=r(1),o=r(5),a=r(3),c=r(0),h=r.n(c),u=r(9),p=r.n(u),l=r(4),d=r.n(l),g=r(8),f=r.n(g);function y(e){const t=[];return e.split("/").forEach(e=>{let r=parseInt(e,10);Number.isNaN(r)||(e.length>1&&"'"===e[e.length-1]&&(r+=2147483648),t.push(r))}),t}const b=e=>{switch(e){case 0:return Buffer.of(13,15,37,217);case 1:return Buffer.of(3,254,226,86);case 2:return Buffer.of(3,178,139,127);default:return Buffer.of(0)}},m=e=>{switch(e){case 0:return Buffer.of(6,161,159);case 1:return Buffer.of(6,161,161);case 2:return Buffer.of(6,161,164);default:return Buffer.of(0)}},v=(e,t)=>(e=((e,t)=>{switch(t){case 0:return(e=e.slice(0))[0]=t,e;case 1:case 2:return Buffer.concat([Buffer.of(t,2+(1&e[64])),e.slice(1,33)]);default:return Buffer.of(0)}})(e,t),{publicKey:_(e),address:w(e)}),_=e=>{const t=e[0],r=e.slice(1);return d.a.encode(Buffer.concat([b(t),r]))},w=e=>{const t=e[0],r=e.slice(1);let n=f()(20);return n.update(r),n.digest(n=Buffer.alloc(20)),d.a.encode(Buffer.concat([m(t),n]))};var k=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};class A{constructor(e){this.transport=e,e.decorateAppAPIMethods(this,["getAddress","signOperation","getVersion"],"XTZ")}getAddress(e,t=!1,r=0,n){return k(this,void 0,void 0,(function*(){n||(n=t?3:2);const i=r,s=y(e),o=Buffer.alloc(1+4*s.length);o[0]=s.length,s.forEach((e,t)=>{o.writeUInt32BE(e,1+4*t)});const a=yield this.transport.send(128,n,0,i,o),c=a[0],h=a.slice(1,1+c);return v(h,r)}))}sign(e,t,r=0,n){return k(this,void 0,void 0,(function*(){const i=y(e);let s=0;const o=Buffer.from(t,"hex"),a=[],c=Buffer.alloc(4*i.length+1);for(c[0]=i.length,i.forEach((e,t)=>{c.writeUInt32BE(e,1+4*t)}),a.push(c);s!==o.length;){const e=230;let t;t=s+e>=o.length?o.length-s:e;const r=Buffer.alloc(t);o.copy(r,0,s,s+t),a.push(r),s+=t}let h,u;for(let e=0;e<a.length;e++){const t=a[e];let i=1;0===e?i=0:e===a.length-1&&(i=129),h=yield this.transport.send(128,n,i,r,t)}if(0===r)u=h.slice(0,h.length-2).toString("hex");else{const e=Buffer.alloc(64);e.fill(0);const t=e.subarray(0,32),r=e.subarray(32,64);let n=0;const i=h.readUInt8(n++);if(49!==i&&48!==i)throw new Error("Cannot parse ledger response.");if(h.readUInt8(n++)+4!==h.length)throw new Error("Cannot parse ledger response.");if(2!==h.readUInt8(n++))throw new Error("Cannot parse ledger response.");let s=h.readUInt8(n++);if(s>32&&(n+=s-32,s=32),h.copy(t,32-s,n,n+s),n+=s,2!==h.readUInt8(n++))throw new Error("Cannot parse ledger response.");let o=h.readUInt8(n++);if(o>32&&(n+=o-32,o=32),h.copy(r,32-o,n,n+o),n+=o,n!==h.length-2)throw new Error("Cannot parse ledger response.");u=e.toString("hex")}return{signature:u}}))}signOperation(e,t,r=0){return this.sign(e,t,r,4)}signHash(e,t,r=0){return this.sign(e,t,r,5)}getVersion(){return k(this,void 0,void 0,(function*(){const[e,t,r,n]=yield this.transport.send(128,0,0,0,Buffer.alloc(0));return{major:t,minor:r,patch:n,bakingApp:1===e}}))}}const x={tz1:new Uint8Array([6,161,159]),tz2:new Uint8Array([6,161,161]),tz3:new Uint8Array([6,161,164]),KT:new Uint8Array([2,90,121]),edpk:new Uint8Array([13,15,37,217]),edsk2:new Uint8Array([13,15,58,7]),spsk:new Uint8Array([17,162,224,201]),p2sk:new Uint8Array([16,81,238,189]),sppk:new Uint8Array([3,254,226,86]),p2pk:new Uint8Array([3,178,139,127]),edesk:new Uint8Array([7,90,60,179,41]),edsk:new Uint8Array([43,246,78,7]),edsig:new Uint8Array([9,245,205,134,18]),spsig:new Uint8Array([13,115,101,19,63]),p2sig:new Uint8Array([54,240,44,52]),sig:new Uint8Array([4,130,43]),Net:new Uint8Array([87,82,0]),nce:new Uint8Array([69,220,169]),b:new Uint8Array([1,52]),o:new Uint8Array([5,116]),Lo:new Uint8Array([133,233]),LLo:new Uint8Array([29,159,109]),P:new Uint8Array([2,170]),Co:new Uint8Array([79,179]),id:new Uint8Array([153,103]),expr:new Uint8Array([13,44,64,27]),TZ:new Uint8Array([2,90,121])},E={block:new Uint8Array([1]),endorsement:new Uint8Array([2]),generic:new Uint8Array([3])},S={"00":"parameter","01":"storage","02":"code","03":"False","04":"Elt","05":"Left","06":"None","07":"Pair","08":"Right","09":"Some","0A":"True","0B":"Unit","0C":"PACK","0D":"UNPACK","0E":"BLAKE2B","0F":"SHA256",10:"SHA512",11:"ABS",12:"ADD",13:"AMOUNT",14:"AND",15:"BALANCE",16:"CAR",17:"CDR",18:"CHECK_SIGNATURE",19:"COMPARE","1A":"CONCAT","1B":"CONS","1C":"CREATE_ACCOUNT","1D":"CREATE_CONTRACT","1E":"IMPLICIT_ACCOUNT","1F":"DIP",20:"DROP",21:"DUP",22:"EDIV",23:"EMPTY_MAP",24:"EMPTY_SET",25:"EQ",26:"EXEC",27:"FAILWITH",28:"GE",29:"GET","2A":"GT","2B":"HASH_KEY","2C":"IF","2D":"IF_CONS","2E":"IF_LEFT","2F":"IF_NONE",30:"INT",31:"LAMBDA",32:"LE",33:"LEFT",34:"LOOP",35:"LSL",36:"LSR",37:"LT",38:"MAP",39:"MEM","3A":"MUL","3B":"NEG","3C":"NEQ","3D":"NIL","3E":"NONE","3F":"NOT",40:"NOW",41:"OR",42:"PAIR",43:"PUSH",44:"RIGHT",45:"SIZE",46:"SOME",47:"SOURCE",48:"SENDER",49:"SELF","4A":"STEPS_TO_QUOTA","4B":"SUB","4C":"SWAP","4D":"TRANSFER_TOKENS","4E":"SET_DELEGATE","4F":"UNIT",50:"UPDATE",51:"XOR",52:"ITER",53:"LOOP_LEFT",54:"ADDRESS",55:"CONTRACT",56:"ISNAT",57:"CAST",58:"RENAME",59:"bool","5A":"contract","5B":"int","5C":"key","5D":"key_hash","5E":"lambda","5F":"list",60:"map",61:"big_map",62:"nat",63:"option",64:"or",65:"pair",66:"set",67:"signature",68:"string",69:"bytes","6A":"mutez","6B":"timestamp","6C":"unit","6D":"operation","6E":"address","6F":"SLICE",70:"DIG",71:"DUG",72:"EMPTY_BIG_MAP",73:"APPLY",74:"chain_id",75:"CHAIN_ID"},$=(()=>{const e={};return Object.keys(S).forEach(t=>{e[S[t]]=t}),e})(),P={"00":"default","01":"root","02":"do","03":"set_delegate","04":"remove_delegate"},O=(()=>{const e={};return Object.keys(P).forEach(t=>{e[P[t]]=t}),e})(),U={opMapping:S,opMappingReverse:$,primMapping:{"00":"int","01":"string","02":"seq","03":{name:"prim",len:0,annots:!1},"04":{name:"prim",len:0,annots:!0},"05":{name:"prim",len:1,annots:!1},"06":{name:"prim",len:1,annots:!0},"07":{name:"prim",len:2,annots:!1},"08":{name:"prim",len:2,annots:!0},"09":{name:"prim",len:3,annots:!0},"0A":"bytes"},primMappingReverse:{0:{false:"03",true:"04"},1:{false:"05",true:"06"},2:{false:"07",true:"08"},3:{true:"09"}},forgeOpTags:{"001":{endorsement:0,seed_nonce_revelation:1,double_endorsement_evidence:2,double_baking_evidence:3,activate_account:4,proposals:5,ballot:6,reveal:7,transaction:8,origination:9,delegation:10},"005":{endorsement:0,seed_nonce_revelation:1,double_endorsement_evidence:2,double_baking_evidence:3,activate_account:4,proposals:5,ballot:6,reveal:107,transaction:108,origination:109,delegation:110}},entrypointMapping:P,entrypointMappingReverse:O},C={"001":"PtCJ7pwoxe8JasnHY8YonnLYjcVHmhiARPJvqcC6VfHT5s8k8sY","002":"PsYLVpVvgbLhAhoqAkMFUo6gudkJ9weNXhUYCiLDzcUpFpkk8Wt","003":"PsddFKi32cMJ2qPjf43Qv5GDWLDPZb3T3bF6fLKiF5HtvHNU7aP","004":"Pt24m4xiPbLDhVgVfABUjirbmda3yohdN82Sp9FeuAXJ4eV9otd","005a":"PsBABY5HQTSkA4297zNHfsZNKtxULfL18y95qb3m53QJiXGmrbU","005":"PsBabyM1eUXZseaJdmXFApDSBqj8YBfwELoxZHHW77EMcAbbwAS","006":"PsCARTHAGazKbHtnKfLzQg3kms52kSRpgnDY982a9oYsSXRLQEb"};var T={prefix:x,watermark:E,forgeMappings:U,protocols:C},B=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};var L={getAddress:({path:e="44'/1729'/0'/0'",displayConfirm:t=!0,curve:r=0}={})=>B(void 0,void 0,void 0,(function*(){const n=yield p.a.create(),i=new A(n);let s;try{s=yield i.getAddress(e,t,r)}catch(e){return n.close(),e}return n.close(),s})),signOperation:({path:e="44'/1729'/0'/0'",rawTxHex:t,curve:r=0,watermark:n=E.generic})=>B(void 0,void 0,void 0,(function*(){const i=yield p.a.create(),s=new A(i);let o;try{const i=`00${n}`.slice(-2);({signature:o}=yield s.signOperation(e,`${i}${t}`,r))}catch(e){return i.close(),e}return i.close(),o})),getVersion:()=>B(void 0,void 0,void 0,(function*(){const e=yield p.a.create(),t=new A(e);let r;try{r=yield t.getVersion()}catch(t){return e.close(),t}return e.close(),r}))},j=r(2),K=r(6);const F=e=>{if("number"==typeof e)return e/1e6;if("string"==typeof e)return parseInt(e,10)/1e6;throw new TypeError('Invalid parameter for "mutez" provided.')},I=e=>new j.BigNumber(new j.BigNumber(e).toFixed(6)).multipliedBy(1e6).toString(),N=(e,t)=>{const r=new Uint8Array(t.length+e.length);return r.set(t),r.set(e,t.length),d.a.encode(K.Buffer.from(r,"hex"))},M=e=>new Uint8Array(e.match(/[\da-f]{2}/gi).map(e=>parseInt(e,16))),q=function e(t){"("===(t=t.replace(/(?:@[a-z_]+)|(?:#.*$)/gm,"").replace(/\s+/g," ").trim()).charAt(0)&&(t=t.slice(1,-1));let r=0,n=!1,i=!1;const s={prim:"",args:[]};let o="";for(let a=0;a<t.length;a++)if(i)o+=t[a],i=!1;else if(a===t.length-1&&!1===n||" "===t[a]&&0===r&&!1===n){if(a===t.length-1&&(o+=t[a]),o){if(o===parseInt(o,10).toString()){if(!s.prim)return{int:o};s.args.push({int:o})}else if("0"===o[0]&&"x"===o[1]){if(o=o.substr(2),!s.prim)return{bytes:o};s.args.push({bytes:o})}else s.prim?s.args.push(e(o)):s.prim=o;o=""}}else if('"'===t[a]&&n){if(n=!1,!s.prim)return{string:o};s.args.push({string:o}),o=""}else'"'!==t[a]||n||0!==r?("\\"===t[a]?i=!0:"("===t[a]?r++:")"===t[a]&&r--,o+=t[a]):n=!0;return s},R=function e(t){let r=[];if(Object.prototype.hasOwnProperty.call(t,"prim"))"Pair"===t.prim?(r.push(e(t.args[0])),r=r.concat(e(t.args[1]))):"Elt"===t.prim?r={key:e(t.args[0]),val:e(t.args[1])}:"True"===t.prim?r=!0:"False"===t.prim&&(r=!1);else if(Array.isArray(t)){const n=t.length;for(let i=0;i<n;i++){const n=e(t[i]);void 0!==n.key?(Array.isArray(r)&&(r={keys:[],vals:[]}),r.keys.push(n.key),r.vals.push(n.val)):r.push(n)}}else r=Object.prototype.hasOwnProperty.call(t,"string")?t.string:Object.prototype.hasOwnProperty.call(t,"int")?parseInt(t.int,10):t;return r},z=function e(t){const r=[];let n=!1,i="",s="",o=0,a=0,c=!1,h=!1;for(let u=0;u<t.length;u++){if("}"!==s&&";"!==s||(s=""),n){if("}"===t[u]?a--:"{"===t[u]&&a++,0===a){const t=e(s);r.push({prim:i.trim(),args:[t]}),s="",a=0,n=!1}}else{if("{"===t[u]){a++,i=s,s="",n=!0;continue}if(h){s+=t[u],h=!1;continue}if(u===t.length-1&&!1===c||";"===t[u]&&0===o&&!1===c){if(u===t.length-1&&(s+=t[u]),""===s.trim()||"}"===s.trim()||";"===s.trim()){s="";continue}r.push(q(s)),s="";continue}'"'===t[u]&&c?c=!1:'"'!==t[u]||c?"\\"===t[u]?h=!0:"("===t[u]?o++:")"===t[u]&&o--:c=!0}s+=t[u]}return r};var D={textEncode:e=>new Uint8Array(K.Buffer.from(e,"utf8")),textDecode:e=>K.Buffer.from(e).toString("utf8"),b582int:e=>{let t=new j.BigNumber(0);const r="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";for(let n=0;n<e.length;n++)t=t.plus(new j.BigNumber(r.indexOf(e[e.length-1-n])).multipliedBy(new j.BigNumber(r.length).exponentiatedBy(n)));return t.toString(16)},totez:F,mutez:I,b58cencode:N,b58cdecode:(e,t)=>d.a.decode(e).slice(t.length),buf2hex:e=>{const t=new Uint8Array(e),r=[];return t.forEach(e=>{const t=`00${e.toString(16)}`.slice(-2);r.push(t)}),r.join("")},hex2buf:M,hexNonce:e=>{let t="";for(;e--;)t+="0123456789abcedf"[16*Math.random()|0];return t},mergebuf:(e,t)=>{const r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r},encodeExpr:e=>{let t=f()(32);return t.update(M(e)),t.digest(t=K.Buffer.alloc(32)),N(t,x.expr)},sexp2mic:q,mic2arr:R,ml2mic:z,ml2tzjson:q,tzjson2arr:R,mlraw2json:z,mintotz:F,tztomin:I},H=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};class Y{constructor({key:e,passphrase:t,email:r,ledgerPath:n="44'/1729'/0'/0'",ledgerCurve:i=0}={}){this.publicKey=()=>D.b58cencode(this._publicKey,x[`${this._curve}pk`]),this.secretKey=()=>{if(!this._secretKey)throw new Error("Secret key not known.");let e=this._secretKey;if("ed"===this._curve){const{privateKey:t}=s.crypto_sign_seed_keypair(e.slice(0,32));e=h()(t)}return D.b58cencode(e,x[`${this._curve}sk`])},this.publicKeyHash=()=>{const e={ed:x.tz1,sp:x.tz2,p2:x.tz3}[this._curve];return D.b58cencode(s.crypto_generichash(20,this._publicKey),e)},this.initialize=({key:e,passphrase:t,email:r})=>H(this,void 0,void 0,(function*(){if(yield s.ready,!this._isLedger&&e||({publicKey:e}=yield L.getAddress({path:this._ledgerPath,displayConfirm:!0,curve:this._ledgerCurve})),r){if(!t)throw new Error("Fundraiser key provided without a passphrase.");const n=D.textDecode(D.textEncode(`${r}${t}`)).normalize("NFKD"),i=o.pbkdf2Sync(e,`mnemonic${n}`,2048,64,"sha512"),{publicKey:a,privateKey:c}=s.crypto_sign_seed_keypair(i.slice(0,32));return this._publicKey=h()(a),this._secretKey=h()(c),this._curve="ed",this._isSecret=!0,!0}if(this._curve=e.substr(0,2),!["sp","p2","ed"].includes(this._curve))throw new Error("Invalid prefix for a key encoding.");if(![54,55,88,98].includes(e.length))throw new Error("Invalid length for a key encoding");const n="e"===e.substring(2,3),i=n?e.slice(3,5):e.slice(2,4);if(!["pk","sk"].includes(i))throw new Error("Invalid prefix for a key encoding.");let c;if(this._isSecret="sk"===i,c=this._isSecret?D.b58cdecode(e,x[`${this._curve}${n?"e":""}sk`]):D.b58cdecode(e,x[`${this._curve}pk`]),n){if(!t)throw new Error("Encrypted key provided without a passphrase.");const e=h()(c.slice(0,8)),r=c.slice(8),n=o.pbkdf2Sync(t,e,32768,32,"sha512");c=s.crypto_secretbox_open_easy(r,new Uint8Array(24),n)}if(this._isSecret)if(this._secretKey=h()(c),"ed"===this._curve)if(64===c.length)this._publicKey=h()(c.slice(32));else{const{publicKey:e,privateKey:t}=s.crypto_sign_seed_keypair(c,"uint8array");this._publicKey=h()(e),this._secretKey=h()(t)}else if("sp"===this._curve){const e=new a.ec("secp256k1").keyFromPrivate(c),t=e.getPublic().getY().toArray()[31]%2?3:2;this._publicKey=h()(new Uint8Array([t].concat(e.getPublic().getX().toArray())))}else{if("p2"!==this._curve)throw new Error("Invalid key");{const e=new a.ec("p256").keyFromPrivate(c),t=e.getPublic().getY().toArray()[31]%2?3:2;this._publicKey=h()(new Uint8Array([t].concat(e.getPublic().getX().toArray())))}}else this._publicKey=h()(c),this._secretKey=void 0;return!0})),this.sign=(e,t)=>H(this,void 0,void 0,(function*(){if(this._isLedger){const r=yield L.signOperation({path:this._ledgerPath,rawTxHex:e,curve:this._ledgerCurve,watermark:t}),n=D.hex2buf(r),i=e+r;return{bytes:e,sig:D.b58cencode(n,x.sig),prefixSig:D.b58cencode(n,x[`${this._curve}sig`]),sbytes:i}}let r=D.hex2buf(e);void 0!==t&&(r=D.mergebuf(t,r));const n=h()(s.crypto_generichash(32,r));if(!this._secretKey)throw new Error("Cannot sign operations without a secret key.");if("ed"===this._curve){const t=s.crypto_sign_detached(n,this._secretKey),r=h()(t),i=e+D.buf2hex(r);return{bytes:e,sig:D.b58cencode(t,x.sig),prefixSig:D.b58cencode(t,x.edsig),sbytes:i}}if("sp"===this._curve){const t=new a.ec("secp256k1").keyFromPrivate(this._secretKey).sign(n,{canonical:!0}),r=new Uint8Array(t.r.toArray(void 0,32).concat(t.s.toArray(void 0,32))),i=h()(r),s=e+D.buf2hex(i);return{bytes:e,sig:D.b58cencode(r,x.sig),prefixSig:D.b58cencode(r,x.spsig),sbytes:s}}if("p2"===this._curve){const t=new a.ec("p256").keyFromPrivate(this._secretKey).sign(n,{canonical:!0}),r=new Uint8Array(t.r.toArray(void 0,32).concat(t.s.toArray(void 0,32))),i=h()(r),s=e+D.buf2hex(i);return{bytes:e,sig:D.b58cencode(r,x.sig),prefixSig:D.b58cencode(r,x.p2sig),sbytes:s}}throw new Error("Provided curve not supported")})),this.verify=(e,t,r=this.publicKey())=>{if(!r)throw new Error("Cannot verify without a public key");const n=h()(D.b58cdecode(r,x[`${this._curve}pk`]));if("sig"!==t.slice(0,3)&&this._curve!==t.slice(0,2))throw new Error("Signature and public key curves mismatch.");const i=s.crypto_generichash(32,D.hex2buf(e)),o=D.b58cdecode(t,x.sig);if("ed"===this._curve)try{return s.crypto_sign_verify_detached(o,i,n)}catch(e){return!1}else if("sp"===this._curve){const e=new a.ec("secp256k1").keyFromPublic(n),t=D.buf2hex(h()(o)),[r,s]=t.match(/([a-f\d]{64})/gi);try{return e.verify(i,{r,s})}catch(e){return!1}}else{if("p2"!==this._curve)throw new Error(`Curve '${this._curve}' not supported`);{const e=new a.ec("p256").keyFromPublic(n),t=D.buf2hex(h()(o)),[r,s]=t.match(/([a-f\d]{64})/gi);try{return e.verify(i,{r,s})}catch(e){return!1}}}},this._isLedger=!e,this._ledgerPath=n,this._ledgerCurve=i,this.ready=this.initialize({key:e,passphrase:t,email:r})}get curve(){return this._curve}get isLedger(){return this._isLedger}set isLedger(e){this._isLedger=e}get ledgerPath(){return this._ledgerPath}set ledgerPath(e){this._ledgerPath=e}get ledgerCurve(){return this._ledgerCurve}set ledgerCurve(e){this._ledgerCurve=e}}var G=r(7),Q=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};class J{constructor(e,t,r){this.smartContractMethodName=e,this.sigs=t,this.args=r,this.name="Invalid parameters error",this.message=`${e} Received ${r.length} arguments while expecting one of the follow signatures (${JSON.stringify(t)})`}}class V{constructor(e,t,r){this.id=e,this.schema=t,this.client=r}get(e){return Q(this,void 0,void 0,(function*(){const t=this.schema.EncodeBigMapKey(e),{packed:r}=yield this.client.packData(t.key,t.type),n=D.encodeExpr(r),i=yield this.client.query(`/chains/${this.client.chain}/blocks/head/context/big_maps/${this.id.toString()}/${n}`);return this.schema.ExecuteOnBigMapValue(i,X(this.client))}))}}const X=e=>({big_map:(t,r)=>{if(!(t&&"int"in t&&void 0!==t.int))return{};const n=new G.Schema(r);return new V(new j.BigNumber(t.int),n,e)}});class W{constructor(e,t){this.client=e,this.address=t,this.methods={},this._init=e=>Q(this,void 0,void 0,(function*(){const t=[];t.push(this.client.query(`/chains/${this.client.chain}/blocks/head/context/contracts/${this.address}`)),t.push(this.client.query(`/chains/${this.client.chain}/blocks/head/context/contracts/${this.address}/entrypoints`));const[{script:r},{entrypoints:n}]=yield Promise.all(t);return this.schema=G.Schema.fromRPCResponse({script:r}),this.parameterSchema=G.ParameterSchema.fromRPCResponse({script:r}),this.entrypoints=n,this._initializeMethods(e,this.parameterSchema,this.entrypoints),!0})),this._initializeMethods=(e,t,r)=>{this.methods={};const n=Object.keys(r);if(t.isMultipleEntryPoint){n.forEach(t=>{this.methods[t]=(...n)=>{const i=new G.ParameterSchema(r[t]);return Z(n,i,t),new ee(this.client,e,i,t,n)}}),Object.keys(t.ExtractSchema()).filter(e=>-1===Object.keys(r).indexOf(e)).forEach(r=>{this.methods[r]=(...n)=>(Z([r,...n],t,r),new ee(this.client,e,t,r,n,!1,!0))})}else{const r=t,n=(...n)=>(Z(n,t,"default"),new ee(this.client,e,r,"default",n,!1));this.methods.default=n}},this.storage=()=>Q(this,void 0,void 0,(function*(){yield this.loaded;const e=yield this.client.query(`/chains/${this.client.chain}/blocks/head/context/contracts/${this.address}/storage`);return this.schema.Execute(e,X(this.client))})),this.balance=()=>Q(this,void 0,void 0,(function*(){return yield this.loaded,this.client.query(`/chains/${this.client.chain}/blocks/head/context/contracts/${this.address}/balance`)})),this.loaded=this._init(t)}}const Z=(e,t,r)=>{const n=t.ExtractSignatures();if(!n.find(t=>t.length===e.length))throw new J(r,n,e)};class ee{constructor(e,t,r,n,i,s=!0,o=!1){this.client=e,this.address=t,this.parameterSchema=r,this.name=n,this.args=i,this.isMultipleEntrypoint=s,this.isAnonymous=o}get schema(){return this.isAnonymous?this.parameterSchema.ExtractSchema()[this.name]:this.parameterSchema.ExtractSchema()}send(e={}){return this.client.transfer(this.toTransferParams(e))}toTransferParams({fee:e,gasLimit:t,storageLimit:r,amount:n=0,mutez:i=!1}={}){return{to:this.address,amount:n,fee:e,gasLimit:t,storageLimit:r,parameters:{entrypoint:this.isMultipleEntrypoint?this.name:"default",value:this.isAnonymous?this.parameterSchema.Encode(this.name,...this.args):this.parameterSchema.Encode(...this.args)},mutez:i}}}var te=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};const re=e=>(e=parseInt(e,10),new Uint8Array([(4278190080&e)>>24,(16711680&e)>>16,(65280&e)>>8,255&e]).buffer),ne=e=>{const t=h()(re(e));return D.buf2hex(t)},ie=e=>e?"ff":"00",se=e=>{const t=Ae(e.code).toLowerCase(),r=Ae(e.storage).toLowerCase();return ne(t.length/2)+t+ne(r.length/2)+r},oe=(e,t)=>{const r=e=>{const t=[];t.push(ie(!0));const r=Ae(e).toLowerCase();return t.push(ne(r.length/2)+r),t.join("")},n=e=>{const t=[],r="default"===e.entrypoint;if(t.push(r?"00":"FF"),!r){const r=Ae(e.value).toLowerCase();if(U.entrypointMappingReverse[e.entrypoint])t.push(U.entrypointMappingReverse[e.entrypoint]);else{const r=Ae({string:e.entrypoint}).toLowerCase();t.push("FF"),t.push(r.slice(8))}t.push((r.length/2).toString(16).padStart(8,"0")),t.push(r)}return t.join("")},i={[`${C["001"]}`]:r,[`${C["002"]}`]:r,[`${C["003"]}`]:r,[`${C["004"]}`]:r,[`${C["005a"]}`]:n,[`${C["005"]}`]:n,[`${C["006"]}`]:n};if(!i[t])throw new Error(`Unrecognized protocol: ${t}`);return i[t](e)},ae=e=>{const t=[`0${parseInt(e.substr(2,1),10)-1}`],r=h()(D.b58cdecode(e,x[e.substr(0,3)]));return t.push(D.buf2hex(r)),t.join("")},ce=(e,t="")=>{const r=[],n={[`${C["001"]}`]:!0,[`${C["002"]}`]:!0,[`${C["003"]}`]:!0,[`${C["004"]}`]:!0},i=e=>!t||n[t]?"K"===e.substr(0,1)?"01":"00":"";if("K"===e.substr(0,1)){r.push(i(e));const t=h()(D.b58cdecode(e,x.KT));r.push(D.buf2hex(t)),r.push("00")}else r.push(i(e)),r.push(ae(e));return r.join("")},he=e=>{const t=[];let r=new j.BigNumber(e,10);if(r.isNaN())throw new TypeError(`Error forging zarith ${e}`);for(;;){if(r.lt(128)){r.lt(16)&&t.push("0"),t.push(r.toString(16));break}{let e=r.mod(128);r=r.minus(e),r=r.dividedBy(128),e=e.plus(128),t.push(e.toString(16))}}return t.join("")},ue=e=>{const t=[];switch(e.substr(0,2)){case"ed":t.push("00");break;case"sp":t.push("01");break;case"p2":t.push("02")}const r=h()(D.b58cdecode(e,x[e.substr(0,4)]));return t.push(D.buf2hex(r)),t.join("")},pe=(e,t)=>{const r=e=>h()(new Uint8Array([U.forgeOpTags["001"][e]])),n=e=>h()(new Uint8Array([U.forgeOpTags["005"][e]])),i={[`${C["001"]}`]:r,[`${C["002"]}`]:r,[`${C["003"]}`]:r,[`${C["004"]}`]:r,[`${C["005a"]}`]:n,[`${C["005"]}`]:n,[`${C["006"]}`]:n};if(!i[t])throw new Error(`Unrecognized protocol: ${t}`);const s=[],o=i[t](e.kind);return s.push(D.buf2hex(o)),"endorsement"===e.kind?s.push(le(e)):"seed_nonce_revelation"===e.kind?s.push(de(e)):"double_endorsement_evidence"===e.kind?s.push(ge(e)):"double_baking_evidence"===e.kind?s.push(fe(e)):"activate_account"===e.kind?s.push(ye(e)):"proposals"===e.kind?s.push(be(e)):"ballot"===e.kind?s.push(me(e)):"reveal"===e.kind?s.push(ve(e,t)):"transaction"===e.kind?s.push(_e(e,t)):"origination"===e.kind?s.push(we(e,t)):"delegation"===e.kind&&s.push(ke(e,t)),s.join("")},le=e=>{const t=h()(re(e.level));return D.buf2hex(t)},de=e=>{const t=[],r=h()(re(e.level));return t.push(D.buf2hex(r)),t.push(e.nonce),t.join("")},ge=e=>{throw new Error("Double endorse forging is not complete")},fe=e=>{throw new Error("Double bake forging is not complete")},ye=e=>{const t=[],r=h()(D.b58cdecode(e.pkh,x.tz1));return t.push(D.buf2hex(r)),t.push(e.secret),t.join("")},be=e=>{throw new Error("Proposal forging is not complete")},me=e=>{const t=[];t.push(ae(e.source));const r=h()(re(e.period));t.push(D.buf2hex(r));const n=h()(D.b58cdecode(e.proposal,x.P));let i;return t.push(D.buf2hex(n)),i="yay"===e.ballot||"yea"===e.ballot?"00":"nay"===e.ballot?"01":"02",t.push(i),t.join("")},ve=(e,t)=>{const r=[];return r.push(ce(e.source,t)),r.push(he(e.fee)),r.push(he(e.counter)),r.push(he(e.gas_limit)),r.push(he(e.storage_limit)),r.push(ue(e.public_key)),r.join("")},_e=(e,t)=>{const r=[];return r.push(ce(e.source,t)),r.push(he(e.fee)),r.push(he(e.counter)),r.push(he(e.gas_limit)),r.push(he(e.storage_limit)),r.push(he(e.amount)),r.push(ce(e.destination)),e.parameters?r.push(oe(e.parameters,t)):r.push(ie(!1)),r.join("")},we=(e,t)=>{const r=(e,t)=>(t.push(ae(e.manager_pubkey)),t.push(he(e.balance)),t.push(ie(e.spendable)),t.push(ie(e.delegatable)),e.delegate?(t.push(ie(!0)),t.push(ae(e.delegate))):t.push(ie(!1)),e.script?(t.push(ie(!0)),t.push(se(e.script))):t.push(ie(!1)),t.join("")),n=(e,t)=>(t.push(he(e.balance)),e.delegate?(t.push(ie(!0)),t.push(ae(e.delegate))):t.push(ie(!1)),t.push(se(e.script)),t.join("")),i={[`${C["001"]}`]:r,[`${C["002"]}`]:r,[`${C["003"]}`]:r,[`${C["004"]}`]:r,[`${C["005a"]}`]:n,[`${C["005"]}`]:n,[`${C["006"]}`]:n},s=[];return s.push(ce(e.source,t)),s.push(he(e.fee)),s.push(he(e.counter)),s.push(he(e.gas_limit)),s.push(he(e.storage_limit)),i[t](e,s)},ke=(e,t)=>{const r=[];return r.push(ce(e.source,t)),r.push(he(e.fee)),r.push(he(e.counter)),r.push(he(e.gas_limit)),r.push(he(e.storage_limit)),e.delegate?(r.push(ie(!0)),r.push(ae(e.delegate))):r.push(ie(!1)),r.join("")},Ae=e=>{const t=e=>{const r=[];if(e instanceof Array){r.push("02");const n=e.map(e=>t(e)).join(""),i=n.length/2;r.push(i.toString(16).padStart(8,"0")),r.push(n)}else if(e instanceof Object)if("prim"in e){const n=e.args?e.args.length:0;if(r.push(U.primMappingReverse[n][`${!!e.annots}`]),r.push(U.opMappingReverse[e.prim]),e.args&&e.args.forEach(e=>r.push(t(e))),e.annots){const t=e.annots.map(e=>{const t=h()(D.textEncode(e));return D.buf2hex(t)}).join("20");r.push((t.length/2).toString(16).padStart(8,"0")),r.push(t)}}else if("bytes"in e){const t=e.bytes.length/2;r.push("0A"),r.push(t.toString(16).padStart(8,"0")),r.push(e.bytes)}else if("int"in e){const t=new j.BigNumber(e.int,10),n="-"===t.toString(2)[0]?"1":"0",i=t.toString(2).replace("-",""),s=i.length<=6?6:(i.length-6)%7?i.length+7-(i.length-6)%7:i.length,o=(i.padStart(s,"0").match(/\d{6,7}/g)||[]).reverse();o[0]=n+o[0];const a=o.map((e,t)=>parseInt((t===o.length-1?"0":"1")+e,2).toString(16).padStart(2,"0")).join("");r.push("00"),r.push(a)}else if("string"in e){const t=D.textEncode(e.string),n=[].slice.call(t).map(e=>e.toString(16).padStart(2,"0")).join(""),i=t.length;r.push("01"),r.push(i.toString(16).padStart(8,"0")),r.push(n)}return r.join("")};return t(e).toUpperCase()};var xe={address:ce,decodeRawBytes:e=>{e=e.toUpperCase();let t=0;const r=r=>{const n=e.slice(t,t+r);return t+=r,n},n=()=>{const e=r(2),i=U.primMapping[e];if(i instanceof Object){const e={prim:U.opMapping[r(2)],args:[...Array(i.len)].map(()=>n()),annots:void 0};if(i.len||delete e.args,i.annots){const t=2*parseInt(r(8),16),n=r(t).match(/[\dA-F]{2}/g);if(n){const t=new Uint8Array(n.map(e=>parseInt(e,16))),r=D.textDecode(t);e.annots=r.split(" ")}}else delete e.annots;return e}if("0A"===e){const e=r(8),t=2*parseInt(e,16);return{bytes:r(t)}}if("01"===e){const e=r(8),t=2*parseInt(e,16),n=r(t).match(/[\dA-F]{2}/g);if(n instanceof Array){const e=new Uint8Array(n.map(e=>parseInt(e,16)));return{string:D.textDecode(e)}}throw new Error("Input bytes error")}if("00"===e){const e=parseInt(r(2),16).toString(2).padStart(8,"0"),t=[e.slice(2)];let n="1"===e[0];for(;n;){const e=parseInt(r(2),16).toString(2).padStart(8,"0");t.push(e.slice(1)),n="1"===e[0]}return{int:new j.BigNumber(t.reverse().join(""),2).toString()}}if("02"===e){const e=r(8),i=2*parseInt(e,16),s=t+i,o=[];for(;s>t;)o.push(n());return o}throw new Error(`Invalid raw bytes: Byte:${e} Index:${t}`)};return n()},encodeRawBytes:Ae,forge:(e,t,r)=>te(void 0,void 0,void 0,(function*(){if(!e.contents)throw new Error("No operation contents provided.");if(!e.branch)throw new Error("No operation branch provided.");const n=h()(D.b58cdecode(e.branch,x.b)),i=[D.buf2hex(n)];return e.contents.forEach(e=>{i.push(pe(e,r))}),{opbytes:i.join(""),opOb:e,counter:t}})),op:pe,endorsement:le,seedNonceRevelation:de,doubleEndorsementEvidence:ge,doubleBakingEvidence:fe,activateAccount:ye,proposals:be,ballot:me,reveal:ve,transaction:_e,origination:we,delegation:ke,parameters:oe,publicKey:ue,publicKeyHash:ae,zarith:he,bool:ie,script:se,toBytesInt32:re,toBytesInt32Hex:ne},Ee=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};var Se=r(10),$e=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};const Pe=(e,t="")=>$e(void 0,void 0,void 0,(function*(){try{yield s.ready}catch(e){throw new Error(e)}const r=s,n=e.substr(0,2);if(![54,55,88,98].includes(e.length))throw new Error("Invalid length for a key encoding");const i="e"===e.substring(2,3);if("ed"===n){if(i){const n=h()(D.b58cdecode(e,x.edesk)),i=n.slice(0,8),s=n.slice(8);if(!t)throw new Error("No password was provided to decrypt the key");const a=o.pbkdf2Sync(t,i,32768,32,"sha512"),c=r.crypto_sign_seed_keypair(r.crypto_secretbox_open_easy(s,new Uint8Array(24),a));return{sk:D.b58cencode(c.privateKey,x.edsk),pk:D.b58cencode(c.publicKey,x.edpk),pkh:D.b58cencode(r.crypto_generichash(20,c.publicKey),x.tz1)}}if(98===e.length)return{sk:e,pk:D.b58cencode(D.b58cdecode(e,x.edsk).slice(32),x.edpk),pkh:D.b58cencode(r.crypto_generichash(20,D.b58cdecode(e,x.edsk).slice(32)),x.tz1)};if(54===e.length){const t=D.b58cdecode(e,x.edsk2),n=r.crypto_sign_seed_keypair(t);return{sk:D.b58cencode(n.privateKey,x.edsk),pk:D.b58cencode(n.publicKey,x.edpk),pkh:D.b58cencode(r.crypto_generichash(20,n.publicKey),x.tz1)}}}return console.error("Invalid prefix for a key encoding"),{sk:"",pk:"",pkh:""}}));var Oe={extractKeys:Pe,generateKeys:(e,t)=>$e(void 0,void 0,void 0,(function*(){try{yield s.ready}catch(e){throw new Error(e)}const r=s,n=yield Object(Se.mnemonicToSeed)(e,t).then(e=>e.slice(0,32)),i=r.crypto_sign_seed_keypair(h()(n));return{mnemonic:e,passphrase:t,sk:D.b58cencode(i.privateKey,x.edsk),pk:D.b58cencode(i.publicKey,x.edpk),pkh:D.b58cencode(r.crypto_generichash(20,i.publicKey),x.tz1)}})),checkAddress:e=>{try{return D.b58cdecode(e,x.tz1),!0}catch(e){return!1}},generateMnemonic:()=>Object(Se.generateMnemonic)(256),sign:(e,t,r,n="")=>$e(void 0,void 0,void 0,(function*(){try{yield s.ready}catch(e){throw new Error(e)}const i=s;if(54===t.length||55===t.length)try{({sk:t}=yield Pe(t,n))}catch(e){throw new Error(e)}let o=D.hex2buf(e);void 0!==r&&(o=D.mergebuf(r,o));const a=i.crypto_sign_detached(i.crypto_generichash(32,o),D.b58cdecode(t,x.edsk),"uint8array"),c=D.b58cencode(a,x.edsig),u=h()(a),p=e+D.buf2hex(u);return{bytes:e,sig:D.b58cencode(a,x.sig),prefixSig:c,sbytes:p}})),verify:(e,t,r)=>$e(void 0,void 0,void 0,(function*(){try{yield s.ready}catch(e){throw new Error(e)}const n=s,i=h()(D.hex2buf(e)),o=D.b58cdecode(t,x.sig);return n.crypto_sign_verify_detached(o,n.crypto_generichash(32,i),D.b58cdecode(r,x.edpk))}))};r.d(t,"Key",(function(){return Y})),r.d(t,"Contract",(function(){return W})),r.d(t,"crypto",(function(){return Oe})),r.d(t,"forge",(function(){return xe})),r.d(t,"utility",(function(){return D})),r.d(t,"ledger",(function(){return L})),r.d(t,"constants",(function(){return T}));t.default=class extends class{constructor(e,t,r=!1){this.query=(e,t,r)=>(void 0===t?void 0===r?r="GET":t={}:void 0===r&&(r="POST"),new Promise((n,s)=>{try{const o=new i.a;o.open(r,this.provider+e,!0),o.onload=()=>{if(this._debugMode&&console.log("Node call:",e,t),200===o.status)if(o.responseText){let t=JSON.parse(o.responseText);this._debugMode&&console.log("Node response:",e,t),t&&void 0!==t.error?s(t.error):(t&&void 0!==t.ok&&(t=t.ok),n(t))}else s("Empty response returned");else o.responseText?s(o.responseText):s(o.statusText)},o.onerror=()=>{s(o.statusText)},"POST"===r?(o.setRequestHeader("Content-Type","application/json"),o.send(JSON.stringify(t))):o.send()}catch(e){s(e)}})),this._provider=e,this._chain=t,this._debugMode=r}get provider(){return this._provider}set provider(e){this._provider=e}get chain(){return this._chain}set chain(e){this._chain=e}get debugMode(){return this._debugMode}set debugMode(e){this._debugMode=e}setProvider(e,t=this.chain){this._provider=e,this._chain=t}}{constructor(e="http://127.0.0.1:8732",t="main",r={}){super(e,t,r.debugMode),this.importKey=(e,t,r)=>Ee(this,void 0,void 0,(function*(){this.key=new Y({key:e,passphrase:t,email:r}),yield this.key.ready})),this.importLedger=(e="44'/1729'/0'/0'",t=0)=>Ee(this,void 0,void 0,(function*(){this.key=new Y({ledgerPath:e,ledgerCurve:t}),yield this.key.ready})),this.account=({balance:e,spendable:t,delegatable:r,delegate:n,fee:i=this.defaultFee,gasLimit:s=10600,storageLimit:o=257})=>Ee(this,void 0,void 0,(function*(){const a={};void 0!==t&&(a.spendable=t),void 0!==r&&(a.delegatable=r),n&&(a.delegate=n);const c=[Object.assign({kind:"origination",balance:D.mutez(e),fee:i,gas_limit:s,storage_limit:o,manager_pubkey:this.key.publicKeyHash()},a)];return this.sendOperation({operation:c})})),this.getBalance=e=>this.query(`/chains/${this.chain}/blocks/head/context/contracts/${e}/balance`),this.getDelegate=e=>this.query(`/chains/${this.chain}/blocks/head/context/contracts/${e}/delegate`).then(e=>e||!1),this.getManager=e=>this.query(`/chains/${this.chain}/blocks/head/context/contracts/${e}/manager_key`),this.getCounter=e=>this.query(`/chains/${this.chain}/blocks/head/context/contracts/${e}/counter`),this.getBaker=e=>this.query(`/chains/${this.chain}/blocks/head/context/delegates/${e}`),this.getHeader=()=>this.query(`/chains/${this.chain}/blocks/head/header`),this.getHeadMetadata=()=>this.query(`/chains/${this.chain}/blocks/head/metadata`),this.getHead=()=>this.query(`/chains/${this.chain}/blocks/head`),this.getHeadHash=()=>this.query(`/chains/${this.chain}/blocks/head/hash`),this.getBallotList=()=>this.query(`/chains/${this.chain}/blocks/head/votes/ballot_list`),this.getProposals=()=>this.query(`/chains/${this.chain}/blocks/head/votes/proposals`),this.getBallots=()=>this.query(`/chains/${this.chain}/blocks/head/votes/ballots`),this.getListings=()=>this.query(`/chains/${this.chain}/blocks/head/votes/listings`),this.getCurrentProposal=()=>this.query(`/chains/${this.chain}/blocks/head/votes/current_proposal`),this.getCurrentPeriod=()=>this.query(`/chains/${this.chain}/blocks/head/votes/current_period_kind`),this.getCurrentQuorum=()=>this.query(`/chains/${this.chain}/blocks/head/votes/current_quorum`),this.awaitOperation=(e,t=10,r=180)=>{if(r<=0)throw new Error("Timeout must be more than 0");if(t<=0)throw new Error("Interval must be more than 0");const n=Math.ceil(r/t)+1;let i=0,s=!1;const o=t=>{t.hash===e&&(s=!0)};return new Promise((e,r)=>{const a=()=>this.getHead().then(c=>{i++;for(let e=3;e>=0;e--)c.operations[e].forEach(o);s?e(c.hash):i>=n?r(new Error("Timeout")):setTimeout(a,1e3*t)});a()})},this.prepareOperation=({operation:e,source:t})=>{let r;const n={},i=[];let s,o=!1,a=[];i.push(this.getHeader()),i.push(this.getHeadMetadata()),a=Array.isArray(e)?[...e]:[e];const c=t||this.key.publicKeyHash();for(let e=0;e<a.length;e++)if(["transaction","origination","delegation"].includes(a[e].kind)){o=!0,i.push(this.getManager(c)),i.push(this.getCounter(c));break}return Promise.all(i).then(([e,t,i,h])=>Ee(this,void 0,void 0,(function*(){if(s=e,o){if(!this.getManagerKey(i,t.protocol)){const e={kind:"reveal",fee:1420,public_key:this.key.publicKey(),source:c,gas_limit:10600,storage_limit:300};a.unshift(e)}r=parseInt(h,10),(!this._counters[c]||this._counters[c]<r)&&(this._counters[c]=r)}n.branch=s.hash,n.contents=(e=>e.map(e=>{const r=Object.assign({},e);if(["proposals","ballot","transaction","origination","delegation"].includes(e.kind)&&void 0===e.source&&(r.source=c),["reveal","transaction","origination","delegation"].includes(e.kind)){void 0===e.fee?r.fee="0":r.fee=`${e.fee}`,void 0===e.gas_limit?r.gas_limit="0":r.gas_limit=`${e.gas_limit}`,void 0===e.storage_limit?r.storage_limit="0":r.storage_limit=`${e.storage_limit}`,void 0!==e.balance&&(r.balance=`${r.balance}`),void 0!==e.amount&&(r.amount=`${r.amount}`);const t=++this._counters[c];r.counter=`${t}`}return this._conformOperation(r,t.next_protocol)}))(a);let u="";if(this._localForge&&!this._validateLocalForge||(u=yield this.query(`/chains/${this.chain}/blocks/${s.hash}/helpers/forge/operations`,n)),n.protocol=t.next_protocol,!this._localForge)return{opbytes:u,opOb:n,counter:r,chainId:s.chain_id};const p=yield xe.forge(n,r,t.next_protocol);if(this._validateLocalForge){if(p.opbytes===u)return Object.assign(Object.assign({},p),{counter:r,chainId:s.chain_id});throw new Error("Forge validation error - local and remote bytes don't match")}return Object.assign(Object.assign({},p),{counter:r,chainId:s.chain_id})})))},this.simulateOperation=({operation:e,source:t})=>this.prepareOperation({operation:e,source:t}).then(e=>(delete e.opOb.protocol,e.opOb.signature="edsigtXomBKi5CTRf5cjATJWSyaRvhfYNHqSUGrn4SdbYRcGwQrUGjzEfQDTuqHhuA8b2d8NarZjz8TRf65WkpQmo423BtomS8Q",this.query(`/chains/${this.chain}/blocks/head/helpers/scripts/run_operation`,{chain_id:e.chainId,operation:e.opOb}))),this.sendOperation=({operation:e,source:t,skipPrevalidation:r=!1,skipSignature:n=!1})=>Ee(this,void 0,void 0,(function*(){const i=yield this.prepareOperation({operation:e,source:t});if(n)i.opbytes+="00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",i.opOb.signature="edsigtXomBKi5CTRf5cjATJWSyaRvhfYNHqSUGrn4SdbYRcGwQrUGjzEfQDTuqHhuA8b2d8NarZjz8TRf65WkpQmo423BtomS8Q";else{const e=yield this.key.sign(i.opbytes,E.generic);i.opbytes=e.sbytes,i.opOb.signature=e.prefixSig}const s=t||this.key.publicKeyHash();return r?this.silentInject(i.opbytes).catch(e=>{throw this._counters[s]=i.counter,e}):this.inject(i.opOb,i.opbytes).catch(e=>{throw this._counters[s]=i.counter,e})})),this.inject=(e,t)=>{const r=[];let n=[];return this.query(`/chains/${this.chain}/blocks/head/helpers/preapply/operations`,[e]).then(e=>{if(!Array.isArray(e))throw new Error("RPC Fail");for(let t=0;t<e.length;t++)for(let i=0;i<e[t].contents.length;i++)r.push(e[t].contents[i]),void 0!==e[t].contents[i].metadata.operation_result&&"failed"===e[t].contents[i].metadata.operation_result.status&&(n=n.concat(e[t].contents[i].metadata.operation_result.errors));if(n.length)throw new Error(JSON.stringify({error:"Operation Failed",errors:n},null,2));return this.query("/injection/operation",t)}).then(e=>({hash:e,operations:r}))},this.silentInject=e=>this.query("/injection/operation",e).then(e=>({hash:e})),this.transfer=({to:e,amount:t,source:r,fee:n=this.defaultFee,parameters:i,gasLimit:s=10600,storageLimit:o=300,mutez:a=!1})=>{const c={kind:"transaction",fee:n,gas_limit:s,storage_limit:o,amount:a?D.mutez(t):t,destination:e};return i&&(c.parameters="string"==typeof i?D.sexp2mic(i):i),this.sendOperation({operation:[c],source:r})},this.activate=(e,t)=>{const r={kind:"activate_account",pkh:e,secret:t};return this.sendOperation({operation:[r],source:e,skipSignature:!0})},this.originate=({balance:e,code:t,init:r,spendable:n=!1,delegatable:i=!1,delegate:s,fee:o=this.defaultFee,gasLimit:a=10600,storageLimit:c=257})=>Ee(this,void 0,void 0,(function*(){const h={code:"string"==typeof t?D.ml2mic(t):t,storage:"string"==typeof r?D.sexp2mic(r):r},u=this.key.publicKeyHash(),p={kind:"origination",fee:o,gas_limit:a,storage_limit:c,balance:D.mutez(e),manager_pubkey:u,spendable:n,delegatable:i,script:h};return s&&(p.delegate=s),this.sendOperation({operation:[p]})})),this.setDelegate=({delegate:e,source:t=this.key.publicKeyHash(),fee:r=this.defaultFee,gasLimit:n=10600,storageLimit:i=0})=>Ee(this,void 0,void 0,(function*(){const s={kind:"delegation",source:t,fee:r,gas_limit:n,storage_limit:i,delegate:e};return this.sendOperation({operation:[s],source:t})})),this.registerDelegate=({fee:e=this.defaultFee,gasLimit:t=10600,storageLimit:r=0}={})=>Ee(this,void 0,void 0,(function*(){const n={kind:"delegation",fee:e,gas_limit:t,storage_limit:r,delegate:this.key.publicKeyHash()};return this.sendOperation({operation:[n]})})),this.typecheckCode=(e,t=1e4)=>this.query(`/chains/${this.chain}/blocks/head/helpers/scripts/typecheck_code`,{program:"string"==typeof e?D.ml2mic(e):e,gas:t}),this.packData=(e,t)=>{const r={data:"string"==typeof e?D.sexp2mic(e):e,type:"string"==typeof t?D.sexp2mic(t):t,gas:"4000000"};return this.query(`/chains/${this.chain}/blocks/head/helpers/scripts/pack_data`,r)},this.typecheckData=(e,t)=>{const r={data:"string"==typeof e?D.sexp2mic(e):e,type:"string"==typeof t?D.sexp2mic(t):t,gas:"4000000"};return this.query(`/chains/${this.chain}/blocks/head/helpers/scripts/typecheck_data`,r)},this.runCode=(e,t,r,n,i=!1)=>{const s=i?"trace_code":"run_code";return this.query(`/chains/${this.chain}/blocks/head/helpers/scripts/${s}`,{amount:`${D.mutez(t)}`,script:"string"==typeof e?D.sexp2mic(e):e,input:"string"==typeof r?D.sexp2mic(r):r,storage:"string"==typeof n?D.sexp2mic(n):n})},this.getManagerKey=(e,t)=>{if(!e)return null;const r={[`${C["001"]}`]:e.key,[`${C["002"]}`]:e.key,[`${C["003"]}`]:e.key,[`${C["004"]}`]:e.key,[`${C["005a"]}`]:e,[`${C["005"]}`]:e,[`${C["006"]}`]:e};if(!r[t])throw new Error(`Unrecognized protocol: ${t}`);return r[t]},this._conformOperation=(e,t)=>{const r=e=>e,n=e=>(delete e.manager_pubkey,delete e.spendable,delete e.delegatable,e);return{[`${C["001"]}`]:r,[`${C["002"]}`]:r,[`${C["003"]}`]:r,[`${C["004"]}`]:r,[`${C["005a"]}`]:n,[`${C["005"]}`]:n,[`${C["006"]}`]:n}[t](e)},this.loadContract=e=>Ee(this,void 0,void 0,(function*(){const t=new W(this,e);return yield t.loaded,t})),this._defaultFee=r.defaultFee||1420,this._localForge=!1!==r.localForge,this._validateLocalForge=r.validateLocalForge||!1,this._counters={}}get defaultFee(){return this._defaultFee}set defaultFee(e){this._defaultFee=e}get localForge(){return this._localForge}set localForge(e){this._localForge=e}get validateLocalForge(){return this._validateLocalForge}set validateLocalForge(e){this._validateLocalForge=e}get counters(){return this._counters}set counters(e){this._counters=e}setProvider(e,t=this.chain){super.setProvider(e,t),this.provider=e,this.chain=t}}}])}));